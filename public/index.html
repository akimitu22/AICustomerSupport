<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ホザナ幼稚園 音声サポート</title>
  <!-- CSP の追加 -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; connect-src 'self' .netlify.functions; img-src 'self'; style-src 'self' 'unsafe-inline';">
  <!-- hybrid-voice-recognition.js をクリティカルパスで読み込む -->
  <script src="js/hybrid-voice-recognition.js"></script>
  <!-- Tiny Segmenter を一度だけ読み込む (重複防止) -->
  <script>
    // Tiny Segmenter が未読み込みの場合のみ挿入
    if (typeof TinySegmenter === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/tiny-segmenter@0.2.0/tiny_segmenter.min.js';
      script.integrity = "sha384-Jh3oDvMGveUuGHJJFXM6qnGXgQ/kyV5cUEqj8BSiJN+EjhQ7QlnUnidA3XrhlGQT"; // SRI ハッシュ
      script.crossOrigin = "anonymous";
      document.head.appendChild(script);
    }
  </script>
  <style>
    body {
      font-family: "Yu Gothic", sans-serif;
      margin: 0;
      padding: 1.5em;
      background: #f4f8fc;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #2a5d84;
    }
    .status, .recognized, .reply {
      margin: 1em 0;
      padding: 1em;
      background: #fff;
      border-left: 5px solid #2a5d84;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #quick-links {
      margin-top: 1.5em;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5em;
    }
    .ql {
      padding: 0.6em 1em;
      background: #2a5d84;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .ql:hover {
      background: #1b4767;
    }
    .action-btn {
      padding: 0.5em 1.2em;
      margin: 0.5em;
      background: #777;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .action-btn:hover {
      background: #555;
    }
    /* 重要なリンクエリア */
    .important-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1em;
      margin: 1.5em 0;
      padding: 1em;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .important-link {
      display: flex;
      align-items: center;
      padding: 0.8em 1.5em;
      background: #417aa4; /* コントラスト強化 */
      color: #fff;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .important-link:hover {
      background: #2a5d84;
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    .important-link img, .important-link svg {
      margin-right: 0.5em;
      width: 24px;
      height: 24px;
    }
    footer {
      text-align: center;
      margin-top: 2em;
      font-size: 0.9em;
      color: #777;
    }
    /* 音声サポート切り替えボタン */
    .voice-support-toggle {
      position: fixed;
      bottom: 2em;
      right: 2em;
      background: #2a5d84;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* ヘルプテキスト */
    .toggle-help-text {
      position: fixed;
      bottom: 5.5em;
      right: 2em;
      background: white;
      padding: 0.5em 1em;
      border-radius: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-size: 14px;
      max-width: 200px;
      text-align: center;
      z-index: 99;
    }
    .voice-support-container {
      display: none;
      margin-top: 2em;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1em;
      background: #f9f9f9;
    }
    .voice-support-container.active {
      display: block;
    }
    /* アクセシビリティ向上のための非表示テキスト */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>

  <h1>ホザナ幼稚園</h1>

  <!-- 重要なリンク -->
  <div class="important-links">
    <a href="https://hosana-kindergarten.com/%E5%B9%BC%E7%A8%9A%E5%9C%92%E8%A6%8B%E5%AD%A6%E4%BA%88%E7%B4%84/" target="_blank" rel="noopener noreferrer" class="important-link" onclick="return navigateWithoutSound(this);">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M3 9h18v10a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
        <path d="M3 9l2.45-4.9A2 2 0 017.24 3h9.52a2 2 0 011.8 1.1L21 9"></path>
        <path d="M12 3v6"></path>
      </svg>
      <span>見学予約</span>
    </a>
    <a href="https://hosana-kindergarten.com/entrance-childcare" target="_blank" rel="noopener noreferrer" class="important-link" onclick="return navigateWithoutSound(this);">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M4 19.5A2.5 2.5 0 016.5 17H20"></path>
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"></path>
      </svg>
      <span>入園案内</span>
    </a>
    <a href="https://hosana-kindergarten.com/contact/" target="_blank" rel="noopener noreferrer" class="important-link" onclick="return navigateWithoutSound(this);">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"></path>
      </svg>
      <span>お問い合わせ</span>
    </a>
    <a href="tel:048-555-2301" class="important-link" onclick="return callWithoutSound(this);">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.36 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.34 1.85.573 2.81.7A2 2 0 0122 16.92z"></path>
      </svg>
      <span>電話で相談</span>
    </a>
  </div>

  <!-- 音声サポート切り替えボタン -->
  <div id="toggle-help-text" class="toggle-help-text">🎤をクリックしてお話しください</div>
  <button id="voice-support-toggle" class="voice-support-toggle" aria-label="音声サポート切替">🎤</button>

  <!-- 音声サポートコンテナ -->
  <div id="voice-support" class="voice-support-container">
    <h2>音声サポート</h2>
    <div id="status" class="status">🎤 マイク準備中です…</div>
    <div id="recognized" class="recognized"></div>
    <div id="reply" class="reply"></div>

    <div id="quick-links"></div>

  </div>

  <footer>
    © 2025 ホザナ幼稚園<br>
    お気軽にご質問ください。
  </footer>

  <!-- 音声サポートサービスのJS - IIFE形式でモジュール化 -->
  <script>
  // ホザナ幼稚園音声サポートシステム
  (function() {
    'use strict';
    
    // プライベート変数
    const APP = {
      isActive: false,
      isClientLoaded: false,
      hybridRecognition: null,
      originalStartVAD: null,
      elements: {},
      mediaResources: {
        stream: null,
        audioContext: null,
        recognition: null,
        currentAudio: null
      }
    };
    
    /**
     * DOM要素を初期化
     */
    function initElements() {
      APP.elements = {
        toggleButton: document.getElementById('voice-support-toggle'),
        toggleHelpText: document.getElementById('toggle-help-text'),
        voiceSupportContainer: document.getElementById('voice-support'),
        status: document.getElementById('status'),
        recognized: document.getElementById('recognized'),
        reply: document.getElementById('reply')
      };
    }
    
    /**
     * 音声サポートを開始
     */
    async function startVoiceSupport() {
      try {
        updateUI(true);
        
        // client.jsが未ロードの場合はロード
        if (!APP.isClientLoaded) {
          await loadClientScript();
          APP.isClientLoaded = true;
        }
        
        // ハイブリッド音声認識を初期化
        initHybridRecognition();
        
        // ハイブリッド認識を開始
        if (APP.hybridRecognition) {
          APP.hybridRecognition.startListening(
            handleIntermediateResult,
            handleFinalResult,
            handleRecognitionError
          );
        }
        
        // オリジナルのstartVAD関数が存在すれば呼び出す
        if (typeof window.originalVADFunction === 'function') {
          APP.isActive = true;
          return window.originalVADFunction();
        }
        
        APP.isActive = true;
        return Promise.resolve();
      } catch (error) {
        console.error('音声サポート開始エラー:', error);
        stopVoiceSupport();
        APP.elements.status.innerHTML = `🔴 エラー: ${error.message || '不明なエラー'}`;
        return Promise.reject(error);
      }
    }

    /**
     * 中間認識結果のハンドラ
     */
    function handleIntermediateResult(text) {
      if (APP.elements.recognized) {
        APP.elements.recognized.innerHTML = `<em>(認識中): ${text}</em>`;
      }
    }
    
    /**
     * 最終認識結果のハンドラ
     */
    function handleFinalResult(result) {
      if (!APP.isActive) return; // 非アクティブなら処理しない
      
      if (APP.elements.recognized) {
        APP.elements.recognized.innerHTML = `<strong>あなた:</strong> ${result.text} <small>(${result.engine})</small>`;
      }
      
      // client.jsの応答関数を呼び出し
      if (typeof window.processVoiceInput === 'function') {
        window.processVoiceInput(result.text);
      }
    }
    
    /**
     * 認識エラーのハンドラ
     */
    function handleRecognitionError(error) {
      console.error('認識エラー:', error);
      
      if (APP.elements.status) {
        if (error.error === 'mic-permission') {
          APP.elements.status.innerHTML = `🔴 マイクの使用許可が必要です。設定を確認してください。`;
        } else {
          APP.elements.status.innerHTML = `🔴 エラー: ${error.error || '不明'} (${error.engine || 'system'})`;
        }
      }
    }
    
    /**
     * 音声サポートを停止
     */
    function stopVoiceSupport() {
      if (!APP.isActive) return; // 既に停止済みなら何もしない
      
      updateUI(false);
      releaseMediaResources();
      
      // ハイブリッド認識を停止
      if (APP.hybridRecognition) {
        try {
          APP.hybridRecognition.stopListening();
          // リソース解放も行う
          APP.hybridRecognition.dispose();
        } catch (e) {
          console.warn('ハイブリッド認識停止中のエラー:', e);
        }
      }
      
      // 表示をクリア
      if (APP.elements.recognized) {
        APP.elements.recognized.innerHTML = '';
      }
      
      // ステータス表示を更新
      if (APP.elements.status) {
        APP.elements.status.innerHTML = '🎤 音声認識は停止しています';
      }
      
      APP.isActive = false;
      console.log('音声サポートを停止しました');
    }
    
    /**
     * UIを更新
     */
    function updateUI(isActive) {
      const { toggleButton, toggleHelpText, voiceSupportContainer } = APP.elements;
      
      if (isActive) {
        voiceSupportContainer.classList.add('active');
        toggleButton.textContent = '✕';
        toggleHelpText.textContent = '✕をクリックして音声サポートを終了';
      } else {
        voiceSupportContainer.classList.remove('active');
        toggleButton.textContent = '🎤';
        toggleHelpText.textContent = '🎤をクリックしてお話しください';
      }
    }
    
    /**
     * メディアリソースを解放
     */
    function releaseMediaResources() {
      // 現在再生中の音声を停止
      if (APP.mediaResources.currentAudio) {
        APP.mediaResources.currentAudio.pause();
        APP.mediaResources.currentAudio = null;
      }
      
      // MediaRecorderがあれば停止
      if (window.mediaRecorder && window.mediaRecorder.state === 'recording') {
        try {
          window.mediaRecorder.stop();
        } catch (e) {
          console.warn('MediaRecorder停止エラー:', e);
        }
      }
      
      // マイクストリームを停止
      if (APP.mediaResources.stream) {
        try {
          APP.mediaResources.stream.getTracks().forEach(track => track.stop());
          APP.mediaResources.stream = null;
        } catch (e) {
          console.warn('マイクストリーム停止エラー:', e);
        }
      }
      
      // 音声コンテキストを閉じる
      if (APP.mediaResources.audioContext && APP.mediaResources.audioContext.state !== 'closed') {
        try {
          APP.mediaResources.audioContext.close();
          APP.mediaResources.audioContext = null;
        } catch (e) {
          console.warn('AudioContext停止エラー:', e);
        }
      }
      
      // Web Speech APIの認識を停止
      if (APP.mediaResources.recognition) {
        try {
          APP.mediaResources.recognition.abort();
          APP.mediaResources.recognition = null;
        } catch (e) {
          console.warn('Web Speech API停止エラー:', e);
        }
      }
      
      // グローバル参照の解放
      if (window.micStream) {
        try {
          window.micStream.getTracks().forEach(track => track.stop());
          window.micStream = null;
        } catch (e) {
          console.warn('グローバルマイク停止エラー:', e);
        }
      }
      
      if (window.audioCtx && window.audioCtx.state !== 'closed') {
        try {
          window.audioCtx.close();
          window.audioCtx = null;
        } catch (e) {
          console.warn('グローバルAudioContext停止エラー:', e);
        }
      }
      
      console.log('すべてのメディアリソースを解放しました');
    }
    
    /**
     * client.jsをロード
     */
    function loadClientScript() {
      return new Promise((resolve, reject) => {
        try {
          // オリジナルのstartVAD関数を保存
          if (typeof window.startVAD === 'function') {
            window.originalVADFunction = window.startVAD;
          }
          
          const script = document.createElement('script');
          script.src = 'client.js';
          script.type = 'module';
          
          script.onload = function() {
            console.log('client.js読み込み完了');
            
            // カスタムイベントを発行
            document.dispatchEvent(new Event('clientLoaded'));
            
            // もともとclient.jsにあった関数がstartVADを定義したら、正しく連携
            if (typeof window.startVAD === 'function' && window.startVAD !== window.originalVADFunction) {
              window.originalVADFunction = window.startVAD;
            }
            
            // ハイブリッド認識機能を確保
            window.startVAD = function() {
              return startVoiceSupport();
            };
            
            resolve();
          };
          
          script.onerror = function(error) {
            console.error('client.js読み込みエラー:', error);
            reject(new Error('スクリプト読み込み失敗'));
          };
          
          document.body.appendChild(script);
        } catch (error) {
          console.error('スクリプト読み込み処理エラー:', error);
          reject(error);
        }
      });
    }
    
    /**
     * ハイブリッド音声認識を初期化
     */
    function initHybridRecognition() {
      if (window.HybridVoiceRecognition && !APP.hybridRecognition) {
        try {
          APP.hybridRecognition = new window.HybridVoiceRecognition({
            language: 'ja-JP',
            whisperApiEndpoint: './.netlify/functions/stt',
            debug: true
          });
          console.log('幼稚園特化型ハイブリッド音声認識を初期化しました');
        } catch (error) {
          console.error('ハイブリッド音声認識初期化エラー:', error);
          APP.elements.status.innerHTML = `🔴 音声認識初期化エラー: ${error.message || '不明なエラー'}`;
        }
      }
    }
    
    /**
     * 外部リンクナビゲーション処理
     */
    window.navigateWithoutSound = function(link) {
      window.open(link.href, '_blank');
      return false; // デフォルトのクリックイベントをキャンセル
    };
    
    /**
     * 電話リンク処理
     */
    window.callWithoutSound = function(link) {
      // モバイルデバイス判定
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      
      // モバイルの場合のみ電話機能を有効に
      if (isMobile) {
        window.location.href = link.href;
      } else {
        alert('お電話でのお問い合わせは 048-555-2301 までお願いします。');
      }
      return false; // デフォルトのクリックイベントをキャンセル
    };
    
    /**
     * 初期化処理
     */
    function init() {
      initElements();
      
      // 音声サポート切り替えボタンのイベント
      APP.elements.toggleButton.addEventListener('click', function() {
        if (APP.isActive) {
          stopVoiceSupport();
        } else {
          startVoiceSupport().catch(error => {
            alert('マイクの利用許可が必要です');
            console.error('音声サポート開始エラー:', error);
          });
        }
      });
      
      // Escキーで音声認識を停止
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && APP.isActive) {
          console.log('Escキーで音声認識を停止します');
          stopVoiceSupport();
        }
      });
      
      // ページを離れる前に音声認識を停止
      window.addEventListener('beforeunload', function() {
        if (APP.isActive) {
          stopVoiceSupport();
        }
      });
      
      // 既存のグローバル関数をオーバーライド前にバックアップ
      if (typeof window.startVAD === 'function') {
        window.originalVADFunction = window.startVAD;
      }
      
      // グローバル関数のエクスポート (連携用)
      window.voiceSupportActive = false;
      window.startVAD = startVoiceSupport;
      window.stopVoiceSupport = stopVoiceSupport;
      window.isVoiceSupportActive = function() { return APP.isActive; };
      
      console.log('音声サポートシステムを初期化しました');
    }
    
    // DOMContentLoadedイベントで初期化
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>