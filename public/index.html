<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- 既存のhead内容はそのまま -->
  <style>
    /* 既存のスタイルはそのまま */
    
    /* マイクボタンの重複表示を修正 */
    #voice-input-container .voice-button {
      display: none; /* 新しい音声入力コンポーネントのボタンを非表示に */
    }
    
    /* またはトグルボタンを非表示に（どちらか選択） */
    /* .voice-support-toggle {
      display: none;
    } */
  </style>
</head>
<body>
  <!-- 既存の内容 -->

  <!-- 音声サポート初期化スクリプトの修正 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggleButton = document.getElementById('voice-support-toggle');
      const toggleHelpText = document.getElementById('toggle-help-text');
      const voiceSupportContainer = document.getElementById('voice-support');
      
      // 音声認識エンジンの選択モード (デフォルトは高精度モード)
      window.useEnhancedVoiceRecognition = true;
      
      // 音声認識結果の処理
      function handleVoiceResult(transcript) {
        console.log('音声認識結果:', transcript);
        
        // 認識結果を表示
        const recognizedElement = document.getElementById('recognized');
        if (recognizedElement) {
          recognizedElement.textContent = `お問合せ内容: ${transcript}`;
        }
        
        // 既存のAI処理関数を使用 - ここが重要
        if (window.processAI && typeof window.processAI === 'function') {
          window.processAI(transcript);
        } else if (window.handleAI && typeof window.handleAI === 'function') {
          window.handleAI(transcript);
        } else {
          // フォールバック: 応答エリアに仮のメッセージを表示
          const replyElement = document.getElementById('reply');
          if (replyElement) {
            replyElement.textContent = `「${transcript}」についてのお問い合わせを受け付けました。担当者からご連絡いたします。`;
          }
        }
      }
      
      // クラスのチェックとポーリング機能
      function checkPrecisionVoiceInputClass(maxAttempts = 10, currentAttempt = 0) {
        if (typeof window.PrecisionVoiceInput === 'function') {
          console.log('PrecisionVoiceInput クラスを検出しました');
          initVoiceInput();
          window.voiceModuleLoaded = true;
          window.voiceSupportActive = true;
        } else if (currentAttempt < maxAttempts) {
          console.log(`PrecisionVoiceInput クラス待機中... (${currentAttempt + 1}/${maxAttempts})`);
          setTimeout(() => checkPrecisionVoiceInputClass(maxAttempts, currentAttempt + 1), 200);
        } else {
          console.error('PrecisionVoiceInput クラスが見つかりませんでした');
          loadFallbackRecognition();
        }
      }
      
      // フォールバック認識の読み込み - 元のclient.jsを利用
      function loadFallbackRecognition() {
        window.useEnhancedVoiceRecognition = false;
        if (!window.clientScriptLoaded) {
          const script = document.createElement('script');
          script.src = 'client.js';
          script.onload = function() {
            console.log('client.js読み込み完了 (フォールバック)');
            window.clientScriptLoaded = true;
            window.voiceSupportActive = true;
            if (window.startVAD) window.startVAD().catch(console.error);
          };
          document.body.appendChild(script);
        } else if (window.startVAD) {
          window.startVAD().catch(console.error);
        }
      }
      
      // 高精度音声入力の初期化
      function initVoiceInput() {
        if (typeof PrecisionVoiceInput === 'function') {
          try {
            // 既存の音声入力があれば破棄
            if (window.voiceInput && typeof window.voiceInput.dispose === 'function') {
              window.voiceInput.dispose();
            }
            
            // 新しいインスタンスを作成
            window.voiceInput = new PrecisionVoiceInput({
              containerId: 'voice-input-container',
              apiEndpoint: '/.netlify/functions/stt',
              language: 'ja-JP',
              onResult: handleVoiceResult
            });
            
            // ステータス表示の更新
            const statusElement = document.getElementById('status');
            if (statusElement) {
              statusElement.innerHTML = '🎤 どうぞお話しください…';
            }
            
            console.log('新しい音声入力システムを初期化しました');
          } catch (error) {
            console.error('音声入力システムの初期化に失敗:', error);
            loadFallbackRecognition();
          }
        } else {
          console.error('PrecisionVoiceInput クラスが見つかりません');
          loadFallbackRecognition();
        }
      }
      
      // 音声認識モジュールの読み込み
      function loadVoiceRecognitionModule() {
        if (window.useEnhancedVoiceRecognition) {
          if (!window.voiceModuleLoaded) {
            const script = document.createElement('script');
            script.src = 'precision-voice-input.js';
            script.onload = function() {
              console.log('precision-voice-input.js読み込み完了');
              checkPrecisionVoiceInputClass();
            };
            script.onerror = function() {
              console.error('precision-voice-input.js読み込み失敗');
              loadFallbackRecognition();
            };
            document.body.appendChild(script);
          } else {
            initVoiceInput();
          }
        } else {
          loadFallbackRecognition();
        }
      }
      
      // ボタンイベントリスナー
      toggleButton.addEventListener('click', function() {
        const isActive = voiceSupportContainer.classList.contains('active');
        
        if (isActive) {
          voiceSupportContainer.classList.remove('active');
          toggleButton.textContent = '🎤';
          toggleHelpText.textContent = '🎤をクリックしてお話しください';
          
          stopAllAudio();
          window.voiceSupportActive = false;
        } else {
          voiceSupportContainer.classList.add('active');
          toggleButton.textContent = '✕';
          toggleHelpText.textContent = '✕をクリックして音声サポートを終了';
          
          loadVoiceRecognitionModule();
        }
      });
      
      // 初期状態を設定
      voiceSupportContainer.classList.remove('active');
      toggleButton.textContent = '🎤';
    });
  </script>
</body>
</html>