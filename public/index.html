<script>
  // 音声サポート切り替え
  document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('voice-support-toggle');
    const toggleHelpText = document.getElementById('toggle-help-text');
    const voiceSupportContainer = document.getElementById('voice-support');
    
    // 音声入力インスタンス保持用
    let voiceInput = null;
    
    // SingleMicVoiceInput クラス定義（フォールバック用）
    class SingleMicVoiceInput {
      constructor({ containerId, apiEndpoint, language = 'ja-JP', onResult }) {
        this.container = document.getElementById(containerId);
        this.onResult = onResult || function() {};
        this.language = language;
        this.isRecording = false;
        this.isProcessing = false;
        this.stream = null;
        this.recorder = null;
        this.chunks = [];
        
        // UIの初期化
        this._initUI();
      }
      
      _initUI() {
        // ボタンとステータス表示を維持
        this.status = document.getElementById('status');
        if (this.status) {
          this.status.textContent = 'フォールバックモードで音声入力を準備中です...';
        }
      }
      
      async start() {
        if (this.isRecording || this.isProcessing) return;
        
        this.isProcessing = true;
        if (this.status) {
          this.status.textContent = 'マイクを準備中...';
        }
        
        try {
          // マイクアクセス
          this.stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true
            }
          });
          
          // MediaRecorder初期化
          const mimeType = 'audio/webm;codecs=opus';
          this.recorder = new MediaRecorder(
            this.stream, 
            MediaRecorder.isTypeSupported(mimeType) ? { mimeType } : undefined
          );
          
          this.chunks = [];
          this.recorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
              this.chunks.push(e.data);
            }
          };
          
          this.recorder.onstop = () => {
            this._processRecording();
          };
          
          // 録音開始
          this.recorder.start();
          this.isRecording = true;
          this.isProcessing = false;
          
          // UIの更新
          if (this.status) {
            this.status.textContent = '🎤 録音中... (お話しください)';
          }
          
          // 30秒で自動停止
          this.maxRecordingTimer = setTimeout(() => {
            if (this.isRecording) {
              this.stop();
            }
          }, 30000);
          
          console.log('フォールバックモードで録音開始');
          
        } catch (error) {
          console.error('マイクアクセスエラー:', error);
          this.isProcessing = false;
          if (this.status) {
            this.status.textContent = 'マイクへのアクセスに失敗しました。権限を確認してください。';
          }
        }
      }
      
      stop() {
        if (!this.isRecording) return;
        
        this.isRecording = false;
        if (this.status) {
          this.status.textContent = '処理中...';
        }
        
        // タイマークリア
        if (this.maxRecordingTimer) {
          clearTimeout(this.maxRecordingTimer);
          this.maxRecordingTimer = null;
        }
        
        // 録音停止
        if (this.recorder && this.recorder.state === 'recording') {
          try {
            this.recorder.stop();
          } catch (e) {
            console.warn('録音停止エラー:', e);
            this._cleanupResources();
          }
        } else {
          this._cleanupResources();
        }
      }
      
      async _processRecording() {
        if (this.chunks.length === 0) {
          this._cleanupResources();
          if (this.status) {
            this.status.textContent = '録音データがありません。もう一度お試しください。';
          }
          return;
        }
        
        try {
          const blob = new Blob(this.chunks, { type: 'audio/webm' });
          
          // リソース解放（早めに）
          this._cleanupResources();
          
          if (this.status) {
            this.status.textContent = '音声認識中...';
          }
          
          // 音声をBase64エンコード
          const arrayBuffer = await blob.arrayBuffer();
          const base64Data = btoa(
            new Uint8Array(arrayBuffer).reduce(
              (data, byte) => data + String.fromCharCode(byte), ''
            )
          );
          
          // STTリクエスト送信（client.jsと同様のエンドポイント）
          const response = await fetch('/.netlify/functions/stt', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              audio: base64Data,
              format: 'audio/webm'
            })
          });
          
          if (!response.ok) {
            throw new Error(`サーバーエラー: ${response.status}`);
          }
          
          const result = await response.json();
          let recognizedText = '';
          
          // レスポンス形式の判定
          if (result.text && typeof result.text === 'string') {
            recognizedText = result.text;
          } else if (result.stt && result.stt.text) {
            recognizedText = result.stt.text;
          } else {
            throw new Error('認識結果が見つかりません');
          }
          
          // テキスト処理
          recognizedText = recognizedText
            .replace(/【質問】|【回答】|【応答】|【返答】/g, '')
            .replace(/[【\[［][^】\]］]*[】\]］]/g, '')
            .trim();
          
          // 結果コールバック呼び出し
          this.onResult(recognizedText);
          
          if (this.status) {
            this.status.textContent = '認識完了';
          }
          
        } catch (error) {
          console.error('音声処理エラー:', error);
          if (this.status) {
            this.status.textContent = `エラーが発生しました: ${error.message}`;
          }
        }
      }
      
      _cleanupResources() {
        // タイマークリア
        if (this.maxRecordingTimer) {
          clearTimeout(this.maxRecordingTimer);
          this.maxRecordingTimer = null;
        }
        
        // レコーダー解放
        this.recorder = null;
        this.chunks = [];
        
        // マイクストリーム解放
        if (this.stream) {
          this.stream.getTracks().forEach(track => track.stop());
          this.stream = null;
        }
        
        this.isProcessing = false;
      }
      
      dispose() {
        if (this.isRecording) {
          this.stop();
        } else {
          this._cleanupResources();
        }
        
        if (this.status) {
          this.status.textContent = '音声入力は停止しています';
        }
      }
    }
    
    // 音声認識結果の処理
    function handleVoiceResult(transcript) {
      console.log('音声認識結果:', transcript);
      
      // 認識結果を表示
      const recognizedElement = document.getElementById('recognized');
      if (recognizedElement) {
        recognizedElement.textContent = `お問合せ内容: ${transcript}`;
      }
      
      // 既存のAI処理関数を使用
      if (window.handleAI && typeof window.handleAI === 'function') {
        window.handleAI(transcript);
      }
    }
    
    // 動的import()で音声モジュールを読み込む
    async function loadVoiceModule() {
      try {
        // ESモジュールとして動的に読み込み
        const module = await import('./precision-voice-input.js');
        return module.default; // デフォルトエクスポートを取得
      } catch (error) {
        console.warn('精度優先音声モジュールの読み込みに失敗:', error);
        return SingleMicVoiceInput; // フォールバッククラスを返す
      }
    }
    
    // トグルボタンのイベントリスナー
    toggleButton.addEventListener('click', async function() {
      const isActive = voiceSupportContainer.classList.contains('active');
      
      if (isActive) {
        // 音声サポートをオフにする
        voiceSupportContainer.classList.remove('active');
        toggleButton.textContent = '🎤';
        toggleHelpText.textContent = '🎤をクリックしてお話しください';
        
        // 音声入力を停止・破棄
        if (voiceInput) {
          voiceInput.dispose();
          voiceInput = null;
        }
        
        // 他の音声を停止
        stopAllAudio();
        
        // 状態をリセット
        window.voiceSupportActive = false;
        
        const statusElement = document.getElementById('status');
        if (statusElement) {
          statusElement.textContent = '🎤 音声認識は停止しています';
        }
        
        console.log('音声サポートを停止しました');
      } else {
        // 音声サポートをオンにする
        voiceSupportContainer.classList.add('active');
        toggleButton.textContent = '✕';
        toggleHelpText.textContent = '✕をクリックして音声サポートを終了';
        
        // 状態を更新
        window.voiceSupportActive = true;
        
        const statusElement = document.getElementById('status');
        if (statusElement) {
          statusElement.textContent = '🎤 音声入力を初期化中...';
        }
        
        try {
          // まだ音声入力がなければ初期化
          if (!voiceInput) {
            // 音声モジュールを動的読み込み
            const VoiceInputClass = await loadVoiceModule();
            
            // 音声入力インスタンスを作成
            voiceInput = new VoiceInputClass({
              containerId: 'voice-support', // コンテナID
              apiEndpoint: '/.netlify/functions/stt', // STTエンドポイント
              language: 'ja-JP',
              onResult: handleVoiceResult
            });
          }
          
          // 音声入力を開始
          voiceInput.start();
          
        } catch (error) {
          console.error('音声入力初期化エラー:', error);
          
          // UIを更新
          voiceSupportContainer.classList.remove('active');
          toggleButton.textContent = '🎤';
          toggleHelpText.textContent = '🎤をクリックしてお話しください';
          
          const statusElement = document.getElementById('status');
          if (statusElement) {
            statusElement.textContent = '⚠️ 音声入力の初期化に失敗しました';
          }
          
          window.voiceSupportActive = false;
        }
      }
    });
  });
  
  // グローバル変数
  window.voiceSupportActive = false;
</script>